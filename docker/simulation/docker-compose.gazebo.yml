# Proxigo UAV Simulation - Gazebo Harmonic (Full 3D Visualization)
# Fixed-Wing and VTOL simulation with full 3D visualization
# Requires X11 display (VcXsrv on Windows)
#
# Usage:
#   # Fixed-wing (default)
#   docker compose -f docker/simulation/docker-compose.gazebo.yml up
#
#   # VTOL
#   PX4_VEHICLE=standard_vtol docker compose -f docker/simulation/docker-compose.gazebo.yml up

version: '3.8'

services:
  # PX4 SITL + Gazebo Harmonic
  px4-sitl:
    image: proxigo/px4-gazebo:harmonic
    container_name: px4_gazebo
    privileged: true
    ports:
      - "14540:14540/udp"  # Offboard (for MAVProxy)
      - "14550:14550/udp"  # QGC UDP (forwarded by MAVProxy)
      - "5760:5760/tcp"    # QGC TCP (forwarded by MAVProxy)
      - "18570:18570/udp"  # GCS
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - PX4_HOME_LAT=${PX4_HOME_LAT:-36.2329}
      - PX4_HOME_LON=${PX4_HOME_LON:--116.8276}
      - PX4_HOME_ALT=${PX4_HOME_ALT:-50}
      - PX4_VEHICLE=${PX4_VEHICLE:-advanced_plane}  # advanced_plane or standard_vtol
      - PX4_SIM_MODEL=gz_${PX4_VEHICLE:-advanced_plane}
      - SYS_AUTOSTART=${SYS_AUTOSTART:-4008}   # 4008=Advanced Plane, 4001=Standard VTOL
      - GZ_SIM_RESOURCE_PATH=/root/PX4-Autopilot/Tools/simulation/gz/models:/root/PX4-Autopilot/Tools/simulation/gz/worlds
      - LIBGL_ALWAYS_SOFTWARE=${LIBGL_ALWAYS_SOFTWARE:-0}
      - QT_X11_NO_MITSHM=1
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - px4-build:/root/PX4-Autopilot/build
      - ../../gazebo_worlds:/gazebo_worlds:ro
      - ../../config/mission:/mission:ro
      - ../../scripts:/scripts:ro
    command: >
      bash -c "
        cd /root/PX4-Autopilot &&
        export PX4_HOME_LAT=${PX4_HOME_LAT:-36.2329} &&
        export PX4_HOME_LON=${PX4_HOME_LON:--116.8276} &&
        export PX4_HOME_ALT=${PX4_HOME_ALT:-50} &&
        export SYS_AUTOSTART=${SYS_AUTOSTART:-4008} &&
        make px4_sitl gz_${PX4_VEHICLE:-advanced_plane}
      "
    healthcheck:
      test: ["CMD", "bash", "-c", "pgrep -f px4 > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 120s
    restart: unless-stopped

volumes:
  px4-build:
    name: px4_build_cache
