# Proxigo UAV Simulation - jMAVSim (Lightweight, No Gazebo)
# Fixed-Wing and VTOL simulation with sensors but no 3D visualization
# Works reliably on Windows/WSL2 without X11 issues
#
# Usage:
#   # Fixed-wing (default)
#   docker compose -f docker/simulation/docker-compose.jmavsim.yml up
#
#   # VTOL
#   PX4_VEHICLE=standard_vtol docker compose -f docker/simulation/docker-compose.jmavsim.yml up

version: '3.8'

services:
  # PX4 SITL + jMAVSim (lightweight simulator)
  # Uses base PX4 image which includes jMAVSim
  px4-sitl:
    image: px4io/px4-dev-simulation-jammy:latest
    container_name: px4_jmavsim
    privileged: true
    ports:
      - "14540:14540/udp"  # Offboard (for MAVProxy)
      - "14550:14550/udp"  # QGC UDP (forwarded by MAVProxy)
      - "5760:5760/tcp"    # QGC TCP (forwarded by MAVProxy)
      - "18570:18570/udp"  # GCS
    environment:
      - PX4_HOME_LAT=${PX4_HOME_LAT:-36.2329}
      - PX4_HOME_LON=${PX4_HOME_LON:--116.8276}
      - PX4_HOME_ALT=${PX4_HOME_ALT:-50}
      - PX4_VEHICLE=${PX4_VEHICLE:-advanced_plane}  # advanced_plane or standard_vtol
      - SYS_AUTOSTART=${SYS_AUTOSTART:-4008}   # 4008=Advanced Plane, 4001=Standard VTOL
    volumes:
      - px4-build:/src/PX4-Autopilot/build
      - ../../config/mission:/mission:ro
      - ../../scripts:/scripts:ro
    command: >
      bash -c "
        if [ ! -d /src/PX4-Autopilot ]; then
          git clone --depth 1 --branch v1.14.0 https://github.com/PX4/PX4-Autopilot.git /src/PX4-Autopilot &&
          cd /src/PX4-Autopilot &&
          git submodule update --init --recursive --depth 1
        fi &&
        cd /src/PX4-Autopilot &&
        export PX4_HOME_LAT=${PX4_HOME_LAT:-36.2329} &&
        export PX4_HOME_LON=${PX4_HOME_LON:--116.8276} &&
        export PX4_HOME_ALT=${PX4_HOME_ALT:-50} &&
        export SYS_AUTOSTART=${SYS_AUTOSTART:-4008} &&
        make px4_sitl jmavsim
      "
    healthcheck:
      test: ["CMD", "bash", "-c", "pgrep -f px4 > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 120s
    restart: unless-stopped

volumes:
  px4-build:
    name: px4_build_cache
